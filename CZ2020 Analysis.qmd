---
title: "New Commuting Zone delineations for the U.S. based on 2020 data"
author: "Christopher S. Fowler"
format: pdf
editor: visual
bibliography: references.bib
---

## Abstract

This paper documents the creation of new 'commuting zones' for the United States based on 2020 geographies and data. Commuting zones originated in the late 1980's as the result of an effort by the Economic Research Service of the U.S. Department of Agriculture to provide a county-based delineation of functional regions that covered the entire U.S. and linked rural areas to their nearest economic center. The commuting zones presented here update the 2010 era definitions available at <https://sites.psu.edu/psucz/> which were themselves an update of delineations based on data from 2000, 1990, and 1980. Additionally, these new delineations incorporate fit statistics and measures of quality to facilitate comparison with earlier decades and to account for the fact that the quality of commuting-based delineations may have been substantially affected by changing patterns of work and residence during and after the covid-19 pandemic. The methodology used here seeks to replicate as nearly as possible the method employed in earlier versions of this delineation using hierarchical clustering on a proportional flows matrix generated from county to county commuting flows. The data and all scripts used to generate them and this paper are available at \<set up git repo\>.

## Background & Summary

Commuting zones (CZ's) originated in the late 1980's as a collaboration between the U.S. Department of Agriculture's Economic Research Service (USDA ERS) and researchers focused on understanding the economics of rural places in the United States [@tolbert1987; @killian1993]. The delineations responded to several critical needs in the data infrastructure of the U.S. including:

-   Economic data is primarily released at the county-level, but county geographies are heterogeneous in terms of population and size and do not represent coherent economic units, so a larger unit built from combinations of counties was desirable, and

-   Metropolitan areas, themselves composed of counties and better able to represent coherent economic units, exclude most rural counties.

In addition to their original purpose, CZ's proved useful for both longitudinal and spatial analysis because they were composed of counties whose geographies change more slowly than other administrative units and because they cover the entirety of the U.S. without gaps. Since their original publication in 1987 CZ's have seen wide use in research on topics ranging from health [@ferro2023; @mullachery2021], poverty [@fowler2014a], racism [@chantarat2022], and energy [@owen2022], to more traditional economic analyses tied to labor markets [@autor2009; @vansandt2023]. Use of the delineations has accelerated in recent years with over forty papers citing the 2016 paper describing the 2010 delineation and steadily rising downloads of the delineation files even as they become more and more dated. A need for an update to the 2010 delineations to incorporate new data from the 2020 census is clearly warranted.

Since the establishment of CZ's in 1987, research on regionalization, the problem of grouping units together to create meaningful super-units has seen significant growth. Major advances in cluster detection of various sorts have led to a range of proposed alternatives to the relatively simple method used to delineate CZ's and the broader class of substantially similar delineations known as 'functional regions' [@foote2021; @dashnelson2016; @karlsson2006; @coombes2014; @halas2016; @halas2018; @halas2019; @florez-revuelta2008; @casado-diaz2016; @foote2016; @kropp2016].

While these alternative methods have much to offer, detailed reviews of alternative methods combined with a range of metrics to assess their quality found significant uncertainty present in both the extant delineations and their alternatives [@fowler2016; @fowler2020; @foote2016]. While the CZ delineations can be fairly critiqued, they benefit from a consistent and simple methodology covering almost half a century of research and give up little to the more complicated alternatives in terms of capturing the kinds of regional effects for which they were designed [@fowler2020].

A larger issue with respect to the quality of the CZ delineations is a changing geography of work in the U.S., hastened by the covid-19 pandemic, that calls into question the use of county to county commuting data as a basis for understanding economic regions [@fowler2023]. The rise of remote work and the continued decline of small and medium sized cities [@franklin2021; @bagchi-sen2020] have redrawn the connections between places that are at the heart of most functional region definitions and suggest that the basis for understanding these regions will need to shift in the near future. Additionally, there has long been an acknowledgement that the geography of regions is not consistent across the U.S. with major differences between the overlapping labor markets of the Northeast and the centralized regions found around Western cities like Denver and Las Vegas [@plane1981]. Despite beginning conversations about alternatives, Federal agencies have decided to retain commuting flows as the basis for generating metropolitan delineations for at least another decade [@officeofmanagementandbudget2021a; @u.s.censusbureau2022a].

In light of the identified uncertainty in both the data and delineation methods employed to generate CZ's it is critical that delineations be accompanied by metrics describing the quality of the delineation [@foote2016]. @fowler2020 documented a detailed set of metrics that allow researchers to distinguish between delineations but also among regions within a single delineation. These metrics allow researchers to address variations in quality as well as fine tune their analyses to differences in whether they are studying labor markets, commuting regions, or some other slight variation on the functional region concept.

This data descriptor documents the generation of CZ's based on recently released data from the 2020 decennial census and incorporating the quality metrics developed by @fowler2020. The data is made freely available along with delineations from previous decades at [https://sites.psu.edu/psucz](https://sites.psu.edu/psucz/){.uri} and the complete replication code for generating the data and evaluation metrics as well as this paper with its accompanying visualizations is available at\<set up git\>

## Methods

The data on which the delineation is based comes from a variety of sources consistent with delineations from earlier decades. The raw data on journey to work counts and core-based statistical area (CBSA) delineations were accessed as tables directly from the census [@u.s.censusbureau2020], while county boundaries were accessed from the Census api using tidycensus [@walker2022]. Quarterly wage data for calculating evaluation metrics was acquired directly from the Bureau of Labor Statistics [@bureauoflaborstatistics2020]. The methodology for delineating 2020 CZ's is meant to replicate the original method by @tolbert1990 with the adaptations to current data sources documented in @fowler2016. The evaluation metrics included with the data are those described in @fowler2020. The core concept underlying the delineation is a measure of connection between counties such that counties where a higher proportion of commuters travel between the counties represents a stronger connection. The metric, called 'proportional flow,' is: $$
\frac{C_{ij}+C_{ji}}{min\left ( W_i,W_j \right )}
$$ where *C~ij~* and *C~ji~* represent the counts of commuters leaving county *i* for county *j* and leaving county *j* for county *i* respectively, and *W~i~* and*W~j~* are the total workforces of those two counties. Consistent with the original methodology any connection that achieved a value greater than 1 was reduced to .999; indicating maximum connectivity. The proportional flow matrix was then converted to a dissimilarity matrix by subtracting the proportional flow value from 1 and setting the diagonal of the resulting matrix equal to zero.

```{r load data generate clusters, include=FALSE}
#Libraries
library(tigris)
library(gt)
library(mapboxapi)
library(tmap)
library(RColorBrewer)

#Run Data Prep script to download data and generate proportional flow matrices for 2010 and 2020
source("./CZ2020 Data Prep.R")

#Should the cluster definition files be output to disk?
output_delineation=TRUE
#Perform cluster analysis on 2020 data
hdata20<-hclust(d = flows.prop,method = "average") #hierarchical cluster analysis
output<-cutree(hdata20, h=.977) #cut point based on method from fowler2016
nCZs<-length(unique(output)) #593 clusters.
out20<-data.frame(
  FIPS=as.numeric(str_sub(names(output),start=8)), #Need to extract FIPS from names of output
  CZ20=output,stringsAsFactors = FALSE) #create dataframe with county names and cluster assignments
county20<-county20%>%left_join(out20,by="FIPS") #join cluster assignments to county data
if(output_delineation==TRUE){
  #Ouput data files for 2020 as csv and shapefile
  county20 %>% select(GEOID,CZ20) %>% write.csv(file="./Output Data/county20.csv") 
  county20 %>% select(GEOID,CZ20,CBSA) %>% st_write(driver = "ESRI Shapefile",dsn = "./Output Data/county20.shp",delete_layer = TRUE) 
  #Output data files for 2020 at Commuting Zone scale
  cz20_out<-county20 %>% select(GEOID,CZ20) %>% group_by(CZ20) %>% summarize()
  cz20_out %>% write.csv(file="./Output Data/cz20.csv")
  cz20_out %>% st_write(driver = "ESRI Shapefile", dsn = "./Output Data/cz20.shp",delete_layer=TRUE)
  rm("cz20_out")
}
rm(list=c("flows.prop","output","out20"))
```

The delineation of commuting zones then uses hierarchical cluster analysis [@Kaufman2009] on this dissimilarity matrix with a cutoff value of .977 utilized in the 2010 delineations as described in @fowler2016 (pp. 274-5). The result is a delineation with `r nCZs` commuting zones. Compared with `r max(county10$OUT10)` in 2010. The delineation includes six commuting zones for Puerto Rico, which was not included in the 2010 delineation. As noted in the technical validation below, alternatives to this cutoff value are worth exploring as it is somewhat arbitrary, but the value does have utility for maintaining consistency across delineations and there is no compelling evidence for the choice of an alternative in the range of descriptive and fit metrics covered below. We can examine the degree to which cluster delineations are similar using the Jacand similarity for each county *c* where *ten_c* is the list of all counties in the same commuting zone as *c* in the 2010 delineation and *twenty_c* is the list of all counties in the same commuting zone as *c* in the 2020 delineation. The Jacand similarity is defined as: $$
Similarity_c=\frac{\left | ten_c\cap twenty_c \right |}{\left | ten_c\cup twenty_c \right |}
$$ with a maximum of 1 and a minimum of 0. For this comparison to work a small allowance has to be made for counties and county equivalents that changed between 2010 and 2020. The most significant change is the move from counties to planning regions in Connecticut. For simplicity, county and county equivalent land-based centroids were joined to 2010-era commuting zones so that each observation in the 2020 data set has exactly one assigned 2010 commuting zone. The Jacand similarity is then based on the assignment of the 2020 observation to its 2010 commuting zone as compared to its assignment to the 2020 delineation.

```{r similarity map, echo=FALSE, results='asis'}
#| label: fig-similarity
#| fig-cap: "Map of Jacand Similarity of 2020 Commuting Zones and 2010 Commuting Zones"
cty<-st_drop_geometry(county20)
#Calculate Jacand Similarity for each county
cty$Score<-NA
for(i in 1:nrow(cty)){
  ten<-cty[which(cty$OUT10==cty[i,"OUT10"]),"FIPS"]
  twenty<-cty[which(cty$CZ20==cty[i,"CZ20"]),"FIPS"]
  #calculate jacand similarity
  both<-length(intersect(ten,twenty))
  all<-length(unique(c(ten,twenty)))
  cty[i,"Score"]<-both/all
}
avg<-round(mean(cty$Score),3) #average for entire delineation, used in text below
avg_noPR<-round(mean(cty[cty$FIPS<72000,"Score"]),3) #as above but drop Puerto Rico as an outlier (no data in 2010)
cty$PopShare<-cty$TotPop20/sum(cty$TotPop20)
wtd_avg_noPR<-round(weighted.mean(x = cty[cty$FIPS<72000,"Score"],w = cty[cty$FIPS<72000,"PopShare"]),3) #weighted average for entire delineation, used in text below
county20<- left_join(county20,cty[,c("FIPS","Score")],by="FIPS")
county20_map<-shift_geometry(county20,position = "outside")
#establish breaks in Score
#min(cty[cty$Score>0,"Score"]) #establish the minimum value so the bottom category is distinct from zero
breaks<-c(0,.03,.25,.5,.75,1)
county20_map$Score_cut<-cut(county20_map$Score,breaks=breaks,
                        labels=c("0",".03-.25",".25-.5",".5-.75",".75-1"),
                        include.lowest = TRUE)
#plot map of Jacand similarity categories
ggplot(county20_map)+
  geom_sf(aes(fill=Score_cut,color=Score_cut))+
  scale_fill_brewer(palette="BuPu",na.value="white")+
  scale_color_brewer(palette="BuPu",na.value="white")+
  theme_void()+
  guides(fill=guide_legend(title="Similarity"),color="none")
rm(list=c("all","both","i","ten","twenty","breaks","nCZs"))
```

On the whole the comparison of the two delineations shows a relatively high level of similarity. The mean similarity score comparing the two delineations is `r avg`, or `r avg_noPR` if the scores for Puerto Rico (not included in the 2010 delineation) are omitted. This value jumps to `r wtd_avg_noPR` if we weight scores based on population; confirming that the most populous places are more stable in terms of their commuting zone membership. @fig-similarity shows the distribution of similarity scores for each county and shows both a high overall fit and the lack of any particularly strong regional effect when it comes to low similarity scores. Overall, the commuting zones for this delineation are quite similar to earlier delineations as further shown in @tbl-diagnostics. The only meaningful differences between the two delineations in terms of general characteristics are the smaller number of CZ's identified in 2020 (particularly notable given the addition of `r length(unique(cty[cty$FIPS %in% 72000:73000,"CZ20"]))` new CZ's for Puerto Rico), the increase in the number of non-contiguous commuting zones (from 3 to 6), and the existence of a very small commuting zone (31 sq. km) comprised solely of Falls Church City, VA whose outlying counties shift to other commuting zones in the 2020 delineation. While there is no 'correct' number of commuting zones, the consolidation of CZ's between 2010 and 2020 is consistent with the expected pattern of consolidation associated with continued growth of the largest urban areas and expanded commuting distances bringing smaller centers into the orbit of larger ones. Even the increased presence of non-contiguous counties is an expected, albeit sometimes conceptually problematic, outcome of increased commuting distances and remote-work opportunities. The existence of single county CZ's has always been a problem for this delineation method, and the addition of Falls Church City to the list of single county CZ's is a reminder that the original methodology included a step where expert opinion was allowed to modify the results-a practice abandoned for the delineations in 2000 and 2010 for its lack of transparency even if it likely increased the quality and usability of the delineations.

```{r descriptives, echo=FALSE, results='asis'}
#| label: tbl-diagnostics
#| tbl-cap: "Diagnostic Statistics comparing 2010 and 2020 Commuting Zones"

#Descriptive table
cz20.descriptive<-descriptive.suite(df=county20,czName="CZ20",popCol="TotPop20")
cz10.descriptive<-descriptive.suite(df=county10,czName="OUT10",popCol="TotPop10")
descriptive.output<-merge(cz20.descriptive,cz10.descriptive,by="Variable",sort = FALSE)
colnames(descriptive.output)<-descriptive.output[1,]
descriptive.output<-descriptive.output[-1,]

#Table
default.table.format(df=descriptive.output)
rm(list=c("cz10.descriptive","cz20.descriptive","descriptive.output","avg","avg_noPR"))
```

We can further examine the characteristics of the new CZ delineation by examining the fit characteristics of commuting zones and individual counties as described in @fowler2020. The purpose of this exercise is to better understand where and how commuting zones differ in terms of their fit with our theoretical understanding of how commuting zones should function. @fowler2020 distinguish between Core, Connection, and Containment as three theoretical frames for understanding functional regions. Here we examine these characteristics summarized for the complete 2020 and 2010 delineations. While a detailed examination exceeds the scope of this article, these values are also calculated for individual counties and as averages for individual CZ's and made available with the provided delineation to aid researchers in understanding gradations in the way counties and CZ's fit the theoretical frame we have established for them.

```{r fit, echo=FALSE, results='asis'}
#| label: tbl-fit
#| tbl-cap: "Fit Statistics comparing 2010 and 2020 Commuting Zones"

#Fit table
cz20.fit<-fit.suite(df=county20,flo=flows,czName="CZ20",czYear=2020,cbsaName="CBSA",popCol="TotPop20")
cz10.fit<-fit.suite(df=county10,flo=flows10,czName="OUT10",czYear=2010,cbsaName="CBSA",popCol="TotPop10")

fit.output<-merge(cz20.fit[[3]],cz10.fit[[3]],by="Variables",sort = FALSE)
colnames(fit.output)<-c("Name","CZ20","OUT10")
fit.output<-fit.output[c(-1,-2),]
#drop rows
fit.output<-fit.output[fit.output$Name %in% c("Min. Core","Core Moran's I","Min. From Core","From Core Moran's I","Contained Moran's I")==FALSE,]
fit.output$Class<-c(rep("Core",4),rep("Connection",3),rep("Containment",3))
#Table
default.table.format(df=fit.output,grp="Class")

#Write data with fit statistics
if(output_delineation==TRUE) {
  write.csv(cz20.fit[[1]],file="./Output Data/county_fit_statistics.csv")
  write.csv(cz20.fit[[2]],file="./Output Data/cz_fit_statistics.csv")
}

#Exploration of fit statistics for individual counties and CZ's described in text.
cty.fit<-cz20.fit[[1]]
#summary(cty.fit)
#cty.fit2<-cty.fit[!is.na(cty.fit$Pair.Wage.Corr),]
#fips<-cty.fit2[cty.fit2$Pair.Wage.Corr==min(cty.fit2$Pair.Wage.Corr),] #Newton Cty Mississippi 28101 has strong negative correlation. It is outside of Meridian MS, but there is nothing to indicate why this area would be so different without substantially more detailed investigation.
cz.fit<-cz20.fit[[2]]
#cz20<-cz.fit[cz.fit$Mean.Wage.Corr ==min(cz.fit$Mean.Wage.Corr),] #CZ 154 On the Illinois/Kentucky border has a county that is entirely in the Shawnee National Forest that is negatively correlated with the rest of the weakly correlated counties. 
#cty.fit[cty.fit$LM.Code==154,]
contain<-cz.fit[cz.fit$Mean.Contain==min(cz.fit$Mean.Contain),] #CZ 552 is in Virginia southwest of the DC metro area but fairly close to Richmond. It has a 
#cty.fit[cty.fit$LM.Code==552,] #includes Fauquier county which is in the DC CBSA and has a very different wage structure than the rest of the counties in the CZ.
rm(list=c("cz20.fit","cz10.fit","fit.output","flows10"))
```

### Core

*Core* refers to whether a commuting zone has an important economic center and how important a role it plays in that commuting zone. This concept is most salient in delineations such as those for (aptly named) core-based statistical areas where the role of this economic center is the driving point of interest. Core-centered delineations do tend to omit many rural places and make difficult and subjective decisions about how big an economic center has to be in order to count as a core. In advance of the release of 2020 metropolitan area delineations the Office of Management and Budget hosted a rather contentious discussion about raising the threshold size for an urban core from 50,000 to 100,000 persons [@pipa2021]. While OMB ultimately decided to retain the 50,000 person threshold, the decision raises important questions about the role of economic centers in defining functional regions and so @tbl-fit reports information on how many CZ's contain an OMB defined core county (77.6% in 2020) as well as what the average number of residents in a CZ who work in a core county (41%) and what the average share of the CZ workforce that lives in the core is (37%). The relatively low numbers for the latter two statistics are a reflection of the fact that many CZ's are conceptually designed around inclusion of exurban and rural places. The results in @tbl-fit are encouraging for their relative stability. The number of metropolitan areas that get split does go up substantially from 36 to 44 but the Core measures are otherwise quite stable across delineations, but see the more detailed analysis of this phenomenon in the technical validation section below. Visual inspection of where and how much these values changed between delineations (omitted for brevity) does not raise any red flags about the new delineation.

### Connection

*Connection* refers to the degree to which counties within a CZ are connected economically. Based on an examination of prior use of CZ delineations this has been most heavily referenced in the economics literature where the idea of a 'labor-shed' assumes that within a CZ wages should move together because the workforce can presumably choose to work for any employer within the CZ leading to an equalizing effect on wages within the labor-shed. Following @fowler2020 I implement a measure of pairwise wage correlation based on five years of BLS wage data. High values for this correlation indicate that ups and downs in wages over a five year period are highly correlated within CZ's at an average of .91 up from .84 in the 2010 delineation. A weakness with this methodology is that CZs with just a single county have, by definition, a perfect correlation so I also provide the correlation with single-county CZ's removed, which is still high at .9. The minimum value across all CZ's is also provided ("Min. Wage Correlation"). Initial inspection of the counties with low (negative) wage correlation does not reveal any systematic flaws, only counties that are quite different from their neighbors but no more similar to other nearby counties. An example is shown in @fig-min-conn-map where CZ 154 on the Illinois/Missouri/Kentucky border includes Pope County, IL, a county dominated by the Shawnee National Forest and negatively correlated with the rest of the weakly correlated counties in the CZ. There is not a better location for Pope County in the neighboring CZ's and so this is not a flaw in the delineation but rather a reflection of the fact that CZ's are designed to be inclusive of rural places and that some places will better fit our conceptual model than others.

```{r minimum connection map,echo=FALSE}
#| label: fig-min-conn-map
#| caption: Detailed map of CZ 154 in Illinois which has the lowest mean wage correlation in the country.
#| sub-caption: Pope County, Illinois is mostly Shawnee National Forest and is negatively correlated with the rest of the weakly correlated counties in the CZ
#| fig-width: 6.5
 
#Join county20 with fit statistics in cty.fit
county20$GEOID_num<-as.numeric(county20$GEOID)
county20<-county20 %>% left_join(cty.fit,by=c("GEOID_num"="FIPS"))
colnames(county20)[colnames(county20)=="Pair.Wage.Corr"]<-"Wage Correlation"


#Map of CZ 154
cz154<-county20[county20$CZ20 %in% c(142,150,151,154,159,160,162,231,312,321),]
cz_bound<-group_by(cz154,CZ20) %>% summarize()%>% st_cast()
pope<-county20[county20$GEOID_num==17151,]
pope$Cty_name<-"Pope Cty, IL"
suppressMessages(cz_tiles <- get_static_tiles(
  location = cz154,
  zoom = 6,
  style_id = "light-v9",
  username = "mapbox"
))
#color palette from Color Brewer
pal<-brewer.pal(7,"RdYlBu")
pal<-pal[c(1:2,4:7)]
bks<-c(-.5,-.25,0,.25,.5,.75,1)
tm_shape(cz_tiles) +
  tm_rgb() +
  tm_shape(cz154) +
  tm_polygons(col = "Wage Correlation",
              alpha = 0.3, palette = pal,breaks=bks,midpoint=NA) +
  tm_shape(cz_bound) +
  tm_borders(col = "black", lwd = 2.5) +
  tm_text("CZ20", remove.overlap = TRUE,size= 1.2) +
  tm_shape(pope) +
  tm_text("Cty_name", size = .8, remove.overlap = TRUE) +
  tm_layout(legend.bg.color = "white") +
  tm_credits("Basemap © Mapbox, © OpenStreetMap", position = c("RIGHT", "BOTTOM"))
```

### Containment

Finally, *containment* is the measure most closely associated with the original intent of CZ's as a unit of analysis for studying rural places and their connections to economic centers. In this conceptual model CZ's function like watersheds where every drop of rain that falls stays within the watershed. In total 93% of the U.S. population lives and works in the same CZ, a clear fit with this conceptual model. When we look at averages across counties within a CZ this number falls to 88% of the population as it does not account for differences in county population size or the comparatively lower containment rates in lightly populated rural counties. This value is unchanged from the 2010 delineation. The CZ with the lowest mean containment sits at 58%, down substantially from the 65% minimum in 2010. The culprit CZ is 552 in Virginia, which sits South and West of the D.C. metro area and North and West of the Richmond metro area. 552 contains Fauquier County, considered part of the DC metro area and exhibiting a strong negative pairwise wage correlation with the other counties in 552 (-.28). Fauquier would seemingly benefit from being transferred into CZ 91 just to the North and East, but it gets pulled a little too hard towards the Richmond-centered CZ 543 to the South, and ends up serving as the 'core' for its own CZ instead of being attached to either of the larger metro areas. @fig-min-cotn-map demonstrates the way this pattern is repeated across the region with smaller CZ's delineated between larger metro areas rather than being distributed to the major metros. A higher cutoff value in the hierarchical clustering algorithm would tend to reduce this problem, but would over-aggregate counties in other parts of the country where commuting patterns overlap less. There is not a clear missallocation here, only another example of the compromises entailed in any delineation seeking to cover a geography as diverse as is found in the U.S..

```{r minimum containment map, echo=FALSE}
#| label: fig-min-cotn-map
#| caption: Detailed map of CZ 552 in Virginia which has the lowest mean containment in the country.
#| sub-caption: Fauquier County, Virginia is part of the DC metropolitan area but also connected to Richmond, VA
#| fig-width: 6.5

#Map of CZ 552
cz552<-county20[county20$CZ20 %in% c(91,542,544,546,550,551,552),]
cz_bound2<-group_by(cz552,CZ20) %>% summarize()%>% st_cast()
fauquier<-county20[county20$GEOID_num==51061,]
fauquier$Cty_name<-"Fauquier County, VA"
suppressMessages(cz_tiles2 <- get_static_tiles(
  location = cz552,
  zoom = 7,
  style_id = "light-v9",
  username = "mapbox",
))
pal<-brewer.pal(6,"BuPu")
bks<-c(.4,.5,.6,.7,.8,.9,1)
tm_shape(cz_tiles2) +
  tm_rgb() +
  tm_shape(cz552) +
  tm_polygons(col = "Contained",
              alpha = 0.3, palette = pal,breaks=bks) +
  tm_shape(cz_bound2) +
  tm_borders(col = "black", lwd = 2.5) +
  tm_text("CZ20", remove.overlap = TRUE,size= 1.2) +
  tm_shape(fauquier) +
  tm_text("Cty_name", size = .8, remove.overlap = TRUE) +
  tm_layout(legend.bg.color = "white") +
  tm_credits("Basemap © Mapbox, © OpenStreetMap", position = c("RIGHT", "BOTTOM"))
```

A comparison of the delineations for 2010 and 2020 confirms the general suitability of the new delineation in terms of the suggested fit metrics. The 2020 delineation appears largely similar to the delineation that preceded it suggesting that it should function reasonably well for longitudinal analysis or for work that seeks to replicate the observational conditions generated under earlier delineations. To this end, the generalized fit statistics should give researchers some degree of comfort that the underlying changes in where and how people work have not fundamentally reshaped the nation's functional regions.

## Data Records

The data associated with this paper are available at the county scale (with 3222 counties assigned to a commuting zone) and at the commuting zone scale (592 commuting zones each assigned an ID). The files are available in two formats; comma separated for ease of use and ESRI shapefile with geometry attached for use in GIS applications. The GIS files are delivered with the data projected to EPSG 5070, U.S. Geological Survey Albers Equal Area Conic projection. Two additional files are made available in csv format containing fit statistics for the county and commuting zones. The fit statistics are those presented in @tbl-fit as well as others described in @fowler2020 and are meant to allow users to examine differences within and between commuting zones in greater detail. All files are available at <https://sites.psu.edu/psucz/> and can be generated from scratch with the code provided at \<git repo\>

## Technical Validation

Three possible issues in the CZ delineations are raised by the similarity measure shown in @fig-similarity and the statistics presented in @tbl-diagnostics and @tbl-fit; the decision to retain the methodology, especially the cutoff value of .977, used in prior delineations, the continued presence of non-contiguous commuting zones, and the significant increase in the number of metropolitan areas split by the new delineation. In this section I briefly explore the characteristics of these potential areas of concern.

### Optimizing Jacand Similarity

In the original methodology for delineating CZ's @tolbert1987 used a cutoff value of .98 in the hierarchical cluster analysis that defined their delineation. @fowler2016 revised this number to .977 as a way of approximating the 1990 delineation (which could not be precisely replicated based on the provided methodology) and carried this value forward to the 2010 delineation. For consistency I use that cutoff here to define the 2020 delineation. Since the number itself is arbitrary and intended to create an approximation of the earlier delineation it is worth considering whether alternative values for the cutoff might improve the Jacand similarity across delineations. To that end @fig-jacand shows the results of a similarity test on cutoffs across a range of values from .8 to .999 and shows the maximum value for Jacand similarity was achieved at a cutoff of .972. At this value the mean Jacand similarity across all CZ's was .679 as compared to .677 at the .977 cutoff. The difference is small but suggests that the cutoff value could be optimized to improve the overall similarity between delineations. However, the difference is small enough that it is unlikely to have a significant impact on the results of most studies and consistency with prior delineations is likely to be more important than the small increase in similarity.

```{r jacand, echo=FALSE}
#| label: fig-jacand
#| fig-cap: "Mean and Standard Deviation of Jacand Similarity for 2010 and 2020 Commuting Zones employing cutoff values from .925 to .999"
#| fig-height: 5
sims<-data.frame(cutoff=seq(from=.925, to=.999, by=.001),Mean=NA,SD=NA)
for(i in 1:length(sims$cutoff)){
  test<-unlist(cutTest(sims[i,"cutoff"]))
  sims[i,c("Mean","SD")]<-test
}
#sims[sims$Mean==max(sims$Mean),"cutoff"] #maximum achieved at .972, value of .679
#plot mean and sd of jacand similarity
ggplot(sims,aes(x=cutoff,y=Mean))+geom_line()+geom_ribbon(aes(ymin=Mean-SD,ymax=Mean+SD),alpha=.2)+
  geom_vline(xintercept=.977,linetype="dashed")+
  annotate("text",x=.9785,y=.82,angle=270, label="Selected Cutoff at .977")+
  geom_vline(xintercept=.972,linetype="dotted")+
  annotate("text",x=.9735,y=.37,angle=270, label="Maximum Mean Jacand Similarity at 972")+
  theme_bw()+theme(legend.position = "none")+
  labs(x="Cutoff Value",y="Mean Jacand Similarity")
```

#### Non-Contiguous Commuting Zones

The initial delineation of commuting zones in 1987 relied on post-hoc expert guidance that moved counties between commuting zones to achieve a result that the analysts felt was more suitable than the raw output of the hierarchical cluster analysis described in the methodology. A key component of this work was to insure that commuting zones were all contiguous. Later revisions in 2000 and 2010 retained the published methodology but dropped the quality control step and allowed for the existence of non-contiguous counties to be part of commuting zones. This is arguably a reasonable decision given the heterogeneity of county sizes and commuting patterns across the United States. It also supports replicability and simplicity in describing the delineation. Nevertheless, the idea of having to drive through a different commuting zone (or multiple zones) to get back to the commuting zone in which you began the trip conflicts with the conceptual model of what a commuting zone is meant to represent. Looking to other kinds of districting problems there is no clear solution; most political districting requires contiguity as a criteria for drawing district @webster2013 while school districts regularly create non-contiguous attendance zones to balance school populations and to promote (or constrain) equitable access to education. This is to say that we cannot *a priori* reject a delineation because of the presence of non-contiguous districts. An analysis of the non-contiguous counties in the 2020 delineation finds a mixture of anomalies based on relatively small commuting flows, particularly in Alaska, and three commuting zone assignments that appear to be real failures of the method to correctly assign counties. @fig-contiguity shows the non-contiguous counties and the commuting zones to which they are assigned. The most significant issue involves San Diego County, California which is inexplicably assigned to a commuting zone to the east of Sacramento that includes South Lake Tahoe and part of Western Nevada. A closer inspection of the commuting data for 2020 shows San Diego containing 1.588 million residents who work within the county but only twelve-thousand who work in neighboring Orange County, seven-thousand in neighboring Riverside County, and six-thousand in nearby Los Angeles County. This allocation seems unlikely in the extreme, but it is what the survey on commuting and the relatively simplistic proportional flow methodology gives us. Similar phenomena (though impacting a much smaller number of people) are visible in Marion County, Mississippi and Madison County, Florida. In both cases the counties are assigned to commuting zones that are geographically distant with credible alternatives to which they could be assigned immediately adjacent to them. A key goal of this paper is to make the commuting zones entirely consistent with previous delineations AND completely replicable. This means that the non-contiguous counties should be retained, but tbl-transform offers a short list of commuting zone reassignments that fix all but one of the non-contiguity problems and result in a more compelling final delineation.

```{r contiguity, echo=FALSE}
#| label: fig-contiguity
#| fig-cap: "Non-Contiguous Counties 2020 Commuting Zones"
#| fig-subcap: "Non-Contiguous Counties (marroon) with arrows pointing to the commuting zone (in blue) to which they are assigned"

#Measure distances between non-contiguous counties and their nearest co-commuting zone border
#nc20<-getDistanceOfNonContiguous(df = county20,czName = "CZ20",fips = "GEOID")
#nc_data<-nc20[[1]]
#nc_lines<-nc20[[2]]
#examine_cty(fips="06073") #San Diego County is bizarrely attached to counties in N. CA where it has very low connection. This is a failure of the method. It appears to be driven by an unbelievably high concentration of residents who work within the county itself.
#examine_cty("08111") #San Juan County Colorado. Has very few connections. Commuting zone is with other mtn communities to the north. Not great, but not terrible.
#examine_cty("20067") #Grant County Kansas joined to counties in CO to the north and west. Should be connected to 211 instead. No good reason for this.
#examine_cty("02060") #Bristol Bay Borough Alaska. This is a failure of the method. Should be in 25 with county that surrounds it. Alaska generally doesn't work well though.
#examine_cty("02185") #North Slope Borough. Same problem as above. Should be in the huge commuting zone that cuts it off
#examine_cty("28091") #Marion County Mississippi. Weirdly connected to a big zone in TX. Clearly a failure of the method as there are two reasonable candidates right next to it.
#examine_cty("12079") #Madison County FL, another failure. Connected to a CZ in Southern FL instead of the clear candidate next door to which it has the largest connection.

#These are inaccurate distances as they are designed for mapping and not for analysis
nc20<-getDistanceOfNonContiguous(df = county20_map,czName = "CZ20",fips = "GEOID")
nc_data<-nc20[[1]]
nc_lines<-nc20[[2]]
county20$NonContig<-ifelse(county20$GEOID %in% nc_data$GEOID,1,0)
county20_map<-shift_geometry(county20,position = "outside")
cz_w_noncontig<-county20_map[county20_map$CZ20 %in% nc_data$CZ20 & county20_map$NonContig==0,]
cz_w_noncontig<-group_by(cz_w_noncontig,CZ20)%>%summarise()
us<-st_union(county20_map)
ggplot()+
  geom_sf(data=us,color="grey20",alpha=.4)+
  geom_sf(data=county20_map[county20_map$NonContig==1,],fill="maroon")+
  geom_sf(data=cz_w_noncontig,fill="blue")+
  geom_sf(data=nc_lines,
          arrow = arrow(angle = 45,
                        ends = "last",
                        type = "open",
                        length = unit(0.25, "cm")),lwd=1.5,color="red")+
  theme_void()+theme(legend.position = "none")
```

```{r transform, echo=FALSE}
#| label: tbl-transform
#| tab-cap: "Suggested changes in commuting zones to solve contiguity problems"
#| fig-width: 6.5
# tbl_transform<-data.frame(GEOID=c("06073","08111","20067","02060","02185","28091","12079"),
#            "County Name"=c("San Diego","San Juan","Grant","Bristol Bay","North Slope","Marion","Madison"),
#            "State Name"=c("CA","CO","KS","AK","AK","MS","FL"),
#            "CZ20"=c(59,80,77,15,15,306,99),
#            "New CZ20"=c(594,79,211,25,15,304,92),
#            Notes=c("New single county CZ",
#                    "Add to adjacent CZ",
#                    "Add to adjacent CZ",
#                    "Add to adjacent CZ",
#                    "Retain non-adjacent CZ",
#                    "Add to adjacent CZ",
#                    "Add to adjacent CZ"
#                    ))
#%>%
#  default.table.format()
```

#### Splitting of Metropolitan Areas

A third area of concern with the revised delineations for 2020 is that they have a significantly increased tendency to split CBSA's when compared to the 2010 delineation (44 as oposed to 36). This increase is somewhat misleading as five additional CBSA splits occur in Puerto Rico, which was not covered by the earlier delineation. CBSA's are delineated with broadly similar criteria; including reliance on Core counties (as defined by population) and strength of connection between counties as measured by commuting data so we should expect CZ's to generally retain these connections between counties. When CZ's split CBSA's it is potentially a sign that we have too many CZ's (they are subdividing functional regions). Conversely, if we programatically preserve CBSA's we will obtain a delineation of CZ's where the functional regions are far larger than intended. To examine this issue I examine the CBSA's that are split by the 2020 delineation. As @fig-split demonstrates the places where CZ's split CBSA's are concentrated in parts of the country with overlapping commuting patterns where the clustering algorithm tends to create smaller CZ's between metropolitan areas. These smaller CZ's end up splitting off metropolitan counties with some regularity. The detail in @fig-min-cotn-map offers an example that is repeated in multiple places where CBSA's are split. Splits tend to be in areas where the functional region concept breaks down somewhat with weak ties spread across multiple cores as it does between the DC and Richmond metro areas. If we reduce the number of commuting zones to eliminate these 'between' CZs we will end up with commuting zones that are too large and capture multiple major economic cores in one unit. While the smaller size of the CZs is a compromise, this compromise is consistent with past practice and an examination of the split CBSAs does not reveal a clear alternative or improvement.

```{r split, echo=FALSE}
#| label: fig-split
#| fig-cap: "CBSA's Split by 2020 Delineation"
#| fig-subcap: "The 2020 delineation splits 44 CBSA's, 8 more than the 2010 delineation"
#| fig-width: 6.5
#which CZ's split 2020 CBSA's and vice versa
splits<-county20[,c("CBSA","CZ20")] %>% st_drop_geometry() %>% table() %>%
as.data.frame() %>% filter(Freq>0) #get a table of CBSA and CZ20 and filter to only those with a frequency greater than 0
CBSA_that_are_split<-splits$CBSA %>% table() %>% as.data.frame() %>% filter(Freq>1) %>% arrange(desc(Freq))#a vector of CBSA's that are split by the 2020 delineation
colnames(CBSA_that_are_split)<-c("CBSA","Freq")
CBSA_that_are_split$CBSA<-as.numeric(levels(CBSA_that_are_split$CBSA)[CBSA_that_are_split$CBSA]) #convert from factor to numeric

CZs_that_are_splitters<-splits[splits$CBSA %in% CBSA_that_are_split$CBSA,"CZ20"] %>% unique() #a vector of CZ's that split CBSA's
CZs_that_are_splitters<-as.numeric(levels(CZs_that_are_splitters)[CZs_that_are_splitters]) #convert from factor to numeric

CZs_that_are_splitters<-county20_map[county20_map$CZ20 %in% CZs_that_are_splitters,] %>% group_by(CZ20) %>% summarize() #union the counties that are part of a splitting CZ
CBSA_that_are_split<-county20_map[county20_map$CBSA %in% CBSA_that_are_split$CBSA,] %>% group_by(CBSA) %>% summarize() #union the counties that are part of a splitting CBSA
us<-st_union(county20_map[county20_map$FIPS %in% c(2000:3000,15000:16000)==FALSE,]) #create a single polygon us object dropping Hawaii and Alaska

#Find the number of CBSAs in Puerto Rico that are split
#puerto_rico<-county20_map[county20_map$FIPS %in% c(72000:72999) & county20_map$CBSA%in% CBSA_that_are_split$CBSA,"CBSA"]
#length(unique(puerto_rico$CBSA))

#plot CBSA's that are split by 2020 delineation
# ggplot()+
#   geom_sf(data=us,fill="white",alpha=.5)+
#   geom_sf(data=CZs_that_are_splitters,aes(fill="CZ's that split CBSA's",color="CZ boundary",alpha=.25))+
#   geom_sf(data=CBSA_that_are_split,aes(fill="CBSA's that are split",color="CBSA boundary",alpha=.25))+
#   scale_fill_manual(values=c("red","blue"))+
#   scale_color_manual(values=c("red","blue"))+
#   theme_void()+theme(legend.position="bottom")+guides(alpha="none",fill=guide_legend(title = element_blank()),color=guide_legend(title = element_blank()))
```

## Code Availability

All code used to generate the data from publicly available sources as well as the code for generating this paper with its accompanying figures is available at <set up git repo>

## References
